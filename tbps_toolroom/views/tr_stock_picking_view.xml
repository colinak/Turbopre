<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>
    
    <!--view search of operations-->
    <record id="view_tr_stock_picking_search" model="ir.ui.view">
      <field name="name">tr.stock.picking.search</field>
      <field name="model">tr.stock.picking</field>
      <field name="type">search</field>
      <field name="arch" type="xml">
        <search string="Toolroom Prestramos">
          <field name="name" string="Referencia"/>
          <field name="picking_type_code" />
          <!--<field name="location_id" />-->
          <!--<field name="location_dest_id" />-->
          <field name="applicant_id" />
          <field name="delivery_id" />
          <field name="date" />
          <!--<field name="stage" />-->
          <group expand='0' string='Filters'>
            <filter name='operation_assignment' string="Asignacciones" domain="[('picking_type_code','=', 'assignment')]"/>
            <filter name='operation_loans' string="Prestamos" domain="[('picking_type_code','=', 'loans')]"/>
            <filter name='operation_reception' string="Recepciones" domain="[('picking_type_code','=', 'reception')]"/>
            <filter name='operation_transfes' string="Transferencias Internas" domain="[('picking_type_code','=', 'transfers')]"/>
            <separator/>
            <filter name="filter_in_date" date="date"/>
          </group>
          <!--<group expand='0' string='Group by...'>-->
            <!--<filter string='Product' name="productgroup" context="{'group_by': 'product_id'}"/>-->
            <!--<filter string='Location' name="locationgroup" domain="[]" context="{'group_by': 'location_id'}"/>-->
            <!--<filter string='Lot/Serial Number' name="Lot_Serial_number" context="{'group_by': 'lot_id'}" groups="stock.group_production_lot"/>-->
          <!--</group>-->
        </search>
      </field>
    </record>

    <!--view form of operations-->
    <record id="view_tr_stock_picking_from" model="ir.ui.view">
      <field name="name">tr.stock.picking.form</field>
      <field name="model">tr.stock.picking</field>
      <field name="type">form</field>
      <field name="arch" type="xml">
        <form string="Toolroom Prestamos">
          <field name="id" invisible="1"/>
          <field name="name" invisible="1"/>
          <field name="date" invisible="1" />
          <field name="company_id" invisible="1" />
          <field name="user_id" invisible="1" />
          <field name="count_line" invisible="1" />
          <!--<widget name="web_ribbon" title="Archivado" bg_color="bg-danger" attrs="{'invisible': [('active', '=', True)]}"/>-->
          <header>
            <button name="action_validate" string="Validar" type="object" class="oe_highlight" 
              attrs="{'invisible': ['|', ('count_line', '=', 0), ('state', '!=', 'draft')]}" />
            <button name="action_cancel_draft" states="done" string="Cancelar" type="object" groups="tbps_toolroom.group_tools_manager,tbps_toolroom.group_tools_system"
              confirm="Si cancela esta operación, se perderán todas sus líneas de ajuste de prestamos, asignaciones, transferencias o devoluciones. ¿Estás seguro de que quieres descartarlo?"
            />
            <field name="state" widget="statusbar" statusbar_visible="draft,done,cancel"/>
          </header>
          <sheet>
            <div class="oe_title">
              <label for="name" string="Referencia" class="oe_edit_only"/>
              <h1>
                <field name="name" string="Descripción" style="width: 85%;"/>
              </h1>
            </div>
            <group col="4">
              <field name="picking_type_code" placeholder="Seleccione" attrs="{'readonly': [('state', '=', 'done')]}" />
              <field name="date" placeholder="Seleccione" attrs="{'readonly': [('state', '=', 'done')]}" />
              <field name="signature_applicant" placeholder="Código del Carnet" required="1" attrs="{'readonly': [('state', '=', 'done')]}" />
              <field name="applicant_id" placeholder="Seleccione" required="1" readonly="1" force_save="1"  />
              <field name="location_id" placeholder="Seleccione" force_save="1" attrs="{'readonly': [('state', '=', 'done')]}" />
              <field name="location_dest_id" placeholder="Seleccione" force_save="1" attrs="{'readonly': [('state', '=', 'done')]}" />
              <field name="signature_deliverer" placeholder="Código del Carnet"
                attrs="{'readonly': [('state', '=', 'done')], 'required': [('picking_type_code', '!=', 'transfers')], 'invisible': [('picking_type_code', '=', 'transfers')]}" />
              <field name="delivery_id" placeholder="Seleccione" readonly="1" force_save="1" 
                attrs="{'required': [('picking_type_code', '!=', 'transfers')], 'invisible': [('picking_type_code', '=', 'transfers')]}" />
            </group>
            <notebook>
              <page string="Reservar Herramientas">
                <!--<field name="move_lines" />-->
                <field name="move_lines" mode="tree,form" options="{'no_create': False, 'no_create_edit': False}"
                  context="{'default_name': name}">
<!--editable="buttom"-->
                  <tree>
                  <!--<tree>-->
                    <field name="name" invisible="True" />
                    <field name="state" invisible="True" />
                    <field name="product_uom_category_id" invisible="True" />
                    <!--[>[><field name="lot_name" required="1" /><]<]-->
                    <!--<field name="product_available_id" string="Herramienta" placeholder="Seleccione" required="1" />-->
                    <field name="product_id" placeholder="Seleccione" required="True" />
                    <field name="location_id" placeholder="Seleccione" optional="show"/>
                    <field name="location_dest_id" placeholder="Seleccione" optional="show" />
                    <field name="product_uom_qty" />
                    <!--<field name="product_uom_qty" string="Reservado"/>-->
                    <field name="qty_done" />
                    <field name="date" string="Fecha Programada" readonly="True" />
                    <field name="lot_ids" string="Códigos TPS" invisible="1" force_save="1"/>
                  </tree>
                  <form>
                    <field name="name" invisible="True" />
                    <field name="product_uom_category_id" invisible="True" />
                    <header>
                      <field name="state" widget="statusbar"/>
                    </header>
                    <group>
                      <group>
                        <field name="product_id" string="Herramienta" placeholder="Seleccione" required="1"
                          domain="[('available_qty', '&gt;', 0)]" />
                        <field name="product_availability" />
                        <!--<field name="product_available_id" string="Herramienta" placeholder="Seleccione" required="1" -->
                          <!--domain="[('available_qty', '&gt;', 0)]"-->
                          <!--/>-->
                        <!--<field name="location_id" placeholder="Seleccione"/>-->
                      </group>
                      <group>
                        <field name="product_uom_qty" string="Reservar" />
                        <!--<field name="product_uom" />-->
                        <!--<field name="location_dest_id" placeholder="Seleccione" />-->
                      </group>
                      <!--<field name="date" string="Fecha Programada" />-->
                      <!--<field name="qty_done" />-->
                      <!--<field name="lot_ids" widget="many2many_tags" />-->
                    </group>
                  </form>

                </field>
              </page>
              <page string="Lineas de Herramientas">
                <field name="move_line_ids" mode="tree,form" widget="section_and_note_one2many" options="{'no_create': False, 'no_create_edit': False}" 
                  context="{'default_product_uom_qty': 1, 'default_qty_done': 1}"
                  >
                    <tree editable="bottom">
                      <field name="lot_name" required="1" />
                      <field name="product_id" string="Herramienta" placeholder="Seleccione" required="1" readonly="1" force_save="1"/>
                      <field name="location_id" placeholder="Seleccione" readonly="1" force_save="1"/>
                      <field name="location_dest_id" placeholder="Seleccione" domain="[('usage', '=', 'internal'), ('id', '!=', location_id)]" />
                      <field name="product_uom_qty" invisible="1" />
                      <field name="qty_done" string="Cantidad" optional="hide" readonly="1" force_save="1" />
                      <field name="product_uom_id" optional="hide" />
                      <field name="lot_id" invisible="1" force_save="1"/>
                      <field name="company_id" invisible="1" force_save="1"/>
                      <field name="product_uom_category_id" invisible="1" force_save="1"/>
                    </tree>
                    <form create="1" edit="1">
                      <field name="product_uom_category_id" invisible="1" />
                      <field name="name" invisible="1" />
                      <field name="company_id" invisible="1" />
                      <group col="4">
                        <field name="lot_name" required="1" />
                        <field name="product_id" string="Herramienta" placeholder="Seleccione" required="1"
                          domain="[('type', '!=', 'service')]"
                          options="{'no_create': True, 'no_create_edit': True}"
                          readonly="1" force_save="1"
                        />
                        <field name="location_id" placeholder="Seleccione" domain="[('usage', '=', 'internal')]" 
                         readonly="1" force_save="1" />
                        <field name="location_dest_id" placeholder="Seleccione" domain="[('usage', '=', 'internal'), ('id', '!=', location_id)]" />
                        <field name="qty_done" string="Cantidad" readonly="1"/>
                        <field name="product_uom_id" readonly="1" force_save="1"/>
                        <field name="date" invisible="1" />
                        <field name="product_uom_qty" invisible="1"/>
                        <field name="lot_id" invisible="1" force_save="1"/>
                      </group>
                    </form>

                </field>
              </page>
            </notebook>
            <group>
              <field name="note" placeholder="Añadir una note interna..."/>
            </group>
          </sheet>
        </form>
      </field>
    </record>

    <!--view tree of operations-->
    <record id="view_tr_stock_picking_tree" model="ir.ui.view">
      <field name="name">tr.stock.picking.tree</field>
      <field name="model">tr.stock.picking</field>
      <field name="type">tree</field>
      <field name="arch" type="xml">
        <tree string="Toolroom Picking">
          <field name="name" string="Referencia" />
          <field name="picking_type_code" />
          <field name="delivery_id" string="Entrega" />
          <field name="applicant_id" string="Recibe" />
          <!--<field name="location_id" string="Desde" />-->
          <!--<field name="location_dest_id" string="Hasta" />-->
          <field name="date" />
          <field name="state" string="Estado" widget="badge" decoration-success="state == 'done'" decoration-info="state == 'draft'" decoration-danger="state == 'cancel'" />
        </tree>
      </field>
    </record>


    <!--view action of operations-->
    <record id="action_tr_stock_picking" model="ir.actions.act_window">
      <field name="name">Prestamos y Devoluciones</field>
      <field name="type">ir.actions.act_window</field>
      <field name="res_model">tr.stock.picking</field>
      <field name="view_mode">tree,form</field>
      <field name="view_id" ref="view_tr_stock_picking_tree" />
      <field name="help" type="html">
        <p class="o_view_nocontent_smiling_face">
          Crear Nuevo Prestamo
        </p>
      </field>
    </record>

    <menuitem 
      id="menu_tr_stock_picking"
      name="Prestamos y Devoluciones"
      parent="tbps_toolroom.menu_operations"
      action="tbps_toolroom.action_tr_stock_picking"
      sequence="2"
      groups="base.group_system,group_tools_system,group_tools_manager,group_tools_user"
    />
  </data>
</odoo>
